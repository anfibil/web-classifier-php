{% extends 'base.html.twig' %}

{% block stylesheets %}
    {% stylesheets
    'assets/css/plugins/iCheck/custom.css'
    'assets/css/plugins/steps/jquery.steps.css'
    'assets/css/plugins/noUiSlider/jquery.nouislider.css'
    'assets/css/plugins/qTip/jquery.qtip.css'
    %}
    <link type="text/css" rel="stylesheet" href="{{ asset_url }}" xmlns="http://www.w3.org/1999/html"/>
    {% endstylesheets %}
{% endblock %}

{% block body %}

    {% if is_granted("IS_AUTHENTICATED_REMEMBERED") %}
        <br><br>
        <div class="row">
            <div class="col-lg-10 col-lg-offset-1">
                <div class="ibox">
                    <div class="ibox-title">
                        <h5>Analysis</h5>
                    </div>
                    <div class="ibox-content">
                        <h2> Configure Your Analysis Parameters </h2>
                        <form id="form" action="#" class="wizard-big">
                            <h1>Dataset</h1>
                            <section>
                                <h2>Select the dataset:</h2>
                                <div class="row">
                                    <div class="col-lg-5">
                                        <div class="form-group">
                                            <select id="dataset" name="dataset" class="form-control required">
                                                {% for dataset in datasets %}
                                                    <option value={{ dataset.id|e }}>{{ dataset.name|e }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-lg-5 col-lg-offset-1">
                                        Add dataset description here.
                                    </div>
                                </div>
                            </section>
                            <h1>Pre-processing</h1>
                            <section>
                                <div class="row">
                                    <div class="col-lg-3">
                                        <label>Undersampling: <i class="fa fa-question-circle parameter_value_off" id="q1"></i></label>

                                        <div class="radio i-checks">
                                            <label><input checked class="required" name="undersampling" type="radio" value="1"> True </label>
                                            <br>
                                            <label><input class="required" name="undersampling" type="radio" value="0"> False </label>
                                        </div>

                                        <div class="row text-center">
                                            <label>Undersampling Rate = <span class="example-val parameter_value" id="undersampling_rate-value"></span>
                                                <span class="parameter_value" id="undersampling_rate-value2"> %</span>
                                            </label>

                                            <div class="col-lg-10 col-lg-offset-1">
                                                <div id="undersampling_rate-slider"></div><input id="undersampling_rate"name="undersampling_rate" type="hidden" value="">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-3">
                                        <label>Oversampling (SMOTE): <i class="fa fa-question-circle parameter_value_off" id="q2"></i></label>

                                        <div class="radio i-checks">
                                            <label><input checked class="required" name="oversampling" type="radio" value="1"> True </label>
                                            <br>
                                            <label><input class="required" name="oversampling" type="radio" value="0"> False </label>
                                        </div>

                                        <div class="row text-center">
                                            <label>SMOTE Percentage = <span class="example-val parameter_value" id="oversampling_percentage-value"></span>
                                                <span class="parameter_value" id="oversampling_percentage-value2"> %</span>
                                            </label>

                                            <div class="col-lg-10 col-lg-offset-1">
                                                <div id="oversampling_percentage-slider"></div><input id="oversampling_percentage" name="oversampling_percentage" type="hidden" value="">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-3"></div>
                                    <div class="col-lg-3"></div>
                                </div>

                            </section>
                            <h1>Model</h1>
                            <section>
                                <h2>Select the Model:</h2>
                                <div class="row">
                                    <div class="col-lg-5">
                                        <div class="form-group">
                                            <select id="model" name="model" class="form-control required">
                                                {% for model in models %}
                                                    <option value={{ model.id|e }}>{{ model.name|e }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-lg-7">
                                        <div class="ibox float-e-margins">
                                            <div class="description-box ibox-content p-m" id="model-description">
                                                <div id="model-descriptions">
                                                    {% for model in models %}
                                                        <div id="model-description-{{ model.id|e }}" style="display: none"> {{ model.description|raw}}</div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </section>
                            <h1>Parameters</h1>
                            <section data-mode="async">
                            </section>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        <div class="wrapper wrapper-content animated fadeIn">
            <div class="row">
                <div class="col-lg-12">
                    <div class="ibox float-e-margins">
                        <div class="ibox-content text-center p-md">
                            <h2><span>Sorry! You must be logged in to access this area.</span></h2>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row text-center">
                <a href="/login" class="btn btn-default btn-sm"><span class="fa fa-sign-in"></span>&nbsp;&nbsp;Login</a>
                <a href="/register" class="btn btn-default btn-sm"><span class="fa fa-user-plus"></span>&nbsp;&nbsp;Register</a>
            </div>
        </div>
    {% endif %}

{% endblock %}
{% block scripts %}
    {{ parent() }}
    {% javascripts
    'assets/js/plugins/steps/jquery.steps.js'
    'assets/js/plugins/validate/jquery.validate.min.js'
    'assets/js/plugins/noUiSlider/jquery.nouislider.all.js'
    'assets/js/plugins/qTip/jquery.qtip.js'
    %}
    <script type="text/javascript" src="{{ asset_url }}"></script>
    {% endjavascripts %}
    <script>
        // Reference: https://github.com/rstaib/jquery-steps/wiki (lots of options to customize this form)
        $(document).ready(function(){
            $("#wizard").steps();
            $("#form").steps({
                bodyTag: "section",
                showFinishButtonAlways: false,
                onStepChanging: function (event, currentIndex, newIndex)
                {
                    // Always allow going backward even if the current step contains invalid fields!
                    if (currentIndex > newIndex)
                    {
                        return true;
                    }

                    //Fills in information for second step based on dataset choice
                    if (currentIndex === 2) {
                        $("#form").steps("remove", 3);
                        $("#form").steps("insert", 3, {
                            title: "Parameters",
                            contentMode: "async",
                            contentUrl: "/analysis/getmodelform?modelid="+ $("#model").val()+"&datasetid="+$("#dataset").val()
                        });
                    }

                    var form = $(this);

                    // Clean up if user went backward before
                    if (currentIndex < newIndex)
                    {
                        // To remove error styles
                        $(".body:eq(" + newIndex + ") label.error", form).remove();
                        $(".body:eq(" + newIndex + ") .error", form).removeClass("error");
                    }

                    // Disable validation on fields that are disabled or hidden.
                    form.validate().settings.ignore = ":disabled,:hidden";

                    // Start validation; Prevent going forward if false
                    return form.valid();
                },
                onFinishing: function (event, currentIndex)
                {
                    var form = $(this);

                    // Disable validation on fields that are disabled.
                    // At this point it's recommended to do an overall check (mean ignoring only disabled fields)
                    form.validate().settings.ignore = ":disabled";

                    // Start validation; Prevent form submission if false
                    return form.valid();
                },
                onFinished: function (event, currentIndex)
                {
                    var form = $(this);

                    submitForm(form.serialize());
                }
            }).validate({
                errorPlacement: function (error, element)
                {
                    element.before(error);
                }
            });

            $("#model").change(function(){
                $("#model-description-" + this.value).show().siblings().hide();
            });

            $("#model").change();

            ///////////////////////////////////
            // Pre-processing Tab
            ///////////////////////////////////

            $('.i-checks').iCheck({
                checkboxClass: 'icheckbox_square-green',
                radioClass: 'iradio_square-green'
            });

            $('#undersampling_rate-slider').noUiSlider({
                start: [50],
                step: 1,
                connect: "lower",
                range: {
                    'min': [1],
                    'max': [100]
                }
            });
            $('#undersampling_rate-slider').Link('lower').to($('#undersampling_rate-value'));
            $('#undersampling_rate-slider').Link('lower').to($('#undersampling_rate'));

            $('#oversampling_percentage-slider').noUiSlider({
                start: [100],
                step: 1,
                connect: "lower",
                range: {
                    'min': [1],
                    'max': [1000]
                }
            });
            $('#oversampling_percentage-slider').Link('lower').to($('#oversampling_percentage-value'));
            $('#oversampling_percentage-slider').Link('lower').to($('#oversampling_percentage'));



            $("#q1").qtip({
                content: {
                    text: 'Adjust class distribution by removing instances from the majority class. Select the desired amount of majority class instances to be used for training .',
                    title:'<i>Undersampling<\/i>'
                },
                style: { classes: 'qtip-rounded qtip-shadow qtip-cream' }
            });
            $("#q2").qtip({
                content: {
                    text: 'Use SMOTE to create synthetic instances of the minority class. Use the slider to select the percentage of new instances to create.',
                    title:'<i>Oversampling <\/i>'
                },
                style: { classes: 'qtip-rounded qtip-shadow qtip-cream' }
            });

            $('.i-checks').on('ifChecked', function(){
                var parameter =  $(this).find(":checked").attr('name');
                var value = $(this).find(":checked").val();
                if (parameter=='undersampling'){
                    if (value == 0){
                        $('#undersampling_rate-slider').attr('disabled', 'disabled');
                        $('#undersampling_rate-value').attr('class', "parameter_value_off");
                        $('#undersampling_rate-value2').attr('class',  "parameter_value_off");
                    }
                    else{
                        $('#undersampling_rate-slider').removeAttr('disabled');
                        $('#undersampling_rate-value').attr('class',  "parameter_value");
                        $('#undersampling_rate-value2').attr('class', "parameter_value");
                    }
                }
                else if (parameter == 'oversampling'){
                    if (value == 0){
                        $('#oversampling_percentage-slider').attr('disabled', 'disabled');
                        $('#oversampling_percentage-value').attr('class', "parameter_value_off");
                        $('#oversampling_percentage-value2').attr('class',  "parameter_value_off");
                    }
                    else{
                        $('#oversampling_percentage-slider').removeAttr('disabled');
                        $('#oversampling_percentage-value').attr('class',  "parameter_value");
                        $('#oversampling_percentage-value2').attr('class', "parameter_value");
                    }
                }
            });

        });

        function submitForm(params){
            window.location.href = '/analysis/run?'+params;
        }

    </script>

    <!-- iCheck plugin -->
    <script src="{{ asset('assets/js/plugins/iCheck/icheck.js') }}"></script>

{% endblock %}